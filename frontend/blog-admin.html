<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Admin - Turrant.ai</title>
    <script>window.TAILWIND_DISABLE_WARNING = true;</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        primary: '#003a37',
                        accent: '#16A085',
                        'accent-light': '#1abc9c',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .ql-container {
            min-height: 300px;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .ql-editor {
            min-height: 300px;
        }
        .ql-toolbar.ql-snow {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            border-color: #e5e7eb;
        }
        .ql-container.ql-snow {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            border-color: #e5e7eb;
        }
        .color-option {
            transition: all 0.2s ease;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            ring: 2px;
            ring-offset: 2px;
        }
        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #e5e7eb;
            border-radius: 9999px;
            font-size: 0.875rem;
        }
        .tag-chip button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1rem;
            height: 1rem;
            border-radius: 9999px;
            background: #9ca3af;
            color: white;
            font-size: 0.75rem;
        }
        .tag-chip button:hover {
            background: #6b7280;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16A085;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .toast.success {
            background: #059669;
        }
        .toast.error {
            background: #dc2626;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-primary mb-2">turrant.ai</h1>
                <p class="text-gray-600">Blog Admin Panel</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition"
                        placeholder="admin@turrant.ai">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition"
                        placeholder="Enter your password">
                </div>
                <div id="loginError" class="text-red-500 text-sm hidden"></div>
                <button type="submit" id="loginBtn"
                    class="w-full bg-accent hover:bg-accent-light text-white font-semibold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
                    <span>Sign In</span>
                    <div id="loginSpinner" class="loading-spinner hidden"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-primary text-white sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <h1 class="text-xl font-bold">turrant.ai</h1>
                        <span class="text-accent">Blog Admin</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="userEmail" class="text-sm text-gray-300 hidden sm:block"></span>
                        <button onclick="logout()" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard View -->
            <div id="dashboardView">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Blog Posts</h2>
                        <p class="text-gray-600">Manage your blog content</p>
                    </div>
                    <button onclick="showEditor()" class="bg-accent hover:bg-accent-light text-white font-semibold py-3 px-6 rounded-lg transition flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        New Post
                    </button>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center">
                                <i data-lucide="file-text" class="w-6 h-6 text-accent"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-gray-900" id="totalPosts">0</p>
                                <p class="text-sm text-gray-600">Total Posts</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-gray-900" id="publishedPosts">0</p>
                                <p class="text-sm text-gray-600">Published</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="edit-3" class="w-6 h-6 text-yellow-600"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-gray-900" id="draftPosts">0</p>
                                <p class="text-sm text-gray-600">Drafts</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Posts Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center gap-4">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                            <input type="text" id="searchPosts" placeholder="Search posts..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none">
                        </div>
                        <select id="filterStatus" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none">
                            <option value="all">All Status</option>
                            <option value="published">Published</option>
                            <option value="draft">Drafts</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Post</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Date</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="postsTableBody" class="divide-y divide-gray-100">
                                <!-- Posts will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noPostsMessage" class="hidden p-12 text-center text-gray-500">
                        <i data-lucide="file-x" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>No posts found</p>
                    </div>
                    <div id="loadingPosts" class="p-12 text-center">
                        <div class="loading-spinner mx-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Editor View -->
            <div id="editorView" class="hidden">
                <div class="flex items-center gap-4 mb-8">
                    <button onclick="showDashboard()" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        Back to Dashboard
                    </button>
                </div>

                <form id="postForm" class="space-y-8">
                    <input type="hidden" id="postId">

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Main Content -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Post Content</h3>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Title *</label>
                                        <input type="text" id="postTitle" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none"
                                            placeholder="Enter post title">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Slug</label>
                                        <input type="text" id="postSlug"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-accent focus:border-transparent outline-none"
                                            placeholder="auto-generated-from-title">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Excerpt *</label>
                                        <textarea id="postExcerpt" required rows="3"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none resize-none"
                                            placeholder="Brief description of the post"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Content *</label>
                                        <div id="editor"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- SEO Section -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">SEO Settings</h3>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Meta Title</label>
                                        <input type="text" id="metaTitle"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none"
                                            placeholder="SEO title (defaults to post title)">
                                        <p class="text-xs text-gray-500 mt-1">Recommended: 50-60 characters</p>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Meta Description</label>
                                        <textarea id="metaDescription" rows="2"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none resize-none"
                                            placeholder="SEO description (defaults to excerpt)"></textarea>
                                        <p class="text-xs text-gray-500 mt-1">Recommended: 150-160 characters</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="space-y-6">
                            <!-- Publish Settings -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Publish</h3>

                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <label class="text-sm font-medium text-gray-700">Published</label>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="postPublished" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/25 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                                        </label>
                                    </div>

                                    <div class="flex items-center justify-between">
                                        <label class="text-sm font-medium text-gray-700">Featured</label>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="postFeatured" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/25 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                                        </label>
                                    </div>

                                    <div class="pt-4 border-t border-gray-100 space-y-3">
                                        <button type="submit" id="saveBtn"
                                            class="w-full bg-accent hover:bg-accent-light text-white font-semibold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
                                            <i data-lucide="save" class="w-5 h-5"></i>
                                            <span id="saveBtnText">Save Post</span>
                                            <div id="saveSpinner" class="loading-spinner hidden"></div>
                                        </button>
                                        <button type="button" onclick="showDashboard()"
                                            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg transition">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Featured Image -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Featured Image</h3>

                                <div id="imageUploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-accent transition cursor-pointer">
                                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                                    <div id="imagePreview" class="hidden">
                                        <img id="previewImg" class="max-w-full h-auto rounded-lg mb-4">
                                        <button type="button" onclick="removeImage()" class="text-red-500 hover:text-red-700 text-sm flex items-center gap-1 mx-auto">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            Remove
                                        </button>
                                    </div>
                                    <div id="uploadPlaceholder">
                                        <i data-lucide="image" class="w-12 h-12 text-gray-400 mx-auto mb-2"></i>
                                        <p class="text-sm text-gray-600">Click to upload or drag and drop</p>
                                        <p class="text-xs text-gray-400 mt-1">PNG, JPG up to 5MB</p>
                                    </div>
                                    <div id="uploadProgress" class="hidden mt-4">
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div id="progressBar" class="bg-accent h-2 rounded-full transition-all" style="width: 0%"></div>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-2">Uploading...</p>
                                    </div>
                                </div>
                                <input type="hidden" id="featuredImage">
                            </div>

                            <!-- Category -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Category</h3>
                                <select id="postCategory"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none">
                                    <option value="">Select a category</option>
                                </select>
                            </div>

                            <!-- Tags -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Tags</h3>
                                <div id="tagsContainer" class="flex flex-wrap gap-2 mb-3"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="tagInput"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none text-sm"
                                        placeholder="Add a tag">
                                    <button type="button" onclick="addTag()"
                                        class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <input type="hidden" id="postTags">
                            </div>

                            <!-- Card Color -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Card Color</h3>
                                <div class="flex gap-3">
                                    <button type="button" onclick="selectColor('teal')"
                                        class="color-option w-10 h-10 rounded-full bg-teal-500 ring-2 ring-transparent ring-offset-2 focus:outline-none"
                                        data-color="teal"></button>
                                    <button type="button" onclick="selectColor('green')"
                                        class="color-option w-10 h-10 rounded-full bg-green-500 ring-2 ring-transparent ring-offset-2 focus:outline-none"
                                        data-color="green"></button>
                                    <button type="button" onclick="selectColor('blue')"
                                        class="color-option w-10 h-10 rounded-full bg-blue-500 ring-2 ring-transparent ring-offset-2 focus:outline-none"
                                        data-color="blue"></button>
                                </div>
                                <input type="hidden" id="cardColor" value="teal">
                            </div>

                            <!-- Author -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Author</h3>
                                <input type="text" id="postAuthor"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none"
                                    placeholder="Author name" value="Turrant Team">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeDeleteModal()"></div>
        <div class="bg-white rounded-2xl p-6 max-w-md w-full relative z-10">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="trash-2" class="w-8 h-8 text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Delete Post</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to delete "<span id="deletePostTitle"></span>"? This action cannot be undone.</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()"
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg transition">
                        Cancel
                    </button>
                    <button onclick="confirmDelete()" id="confirmDeleteBtn"
                        class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
                        <span>Delete</span>
                        <div id="deleteSpinner" class="loading-spinner hidden" style="border-top-color: white;"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://pqjmppaewnvgwlckqqsz.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_WBrpt8gzkbkmiwwE1Robeg_Ib0VZB7R';

        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let currentUser = null;
        let quill = null;
        let tags = [];
        let deletePostId = null;
        let categories = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await checkAuth();
            setupEventListeners();
        });

        // Authentication
        async function checkAuth() {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                currentUser = session.user;
                showAdminDashboard();
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showAdminDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
            initializeEditor();
            loadCategories();
            loadPosts();
            lucide.createIcons();
        }

        async function login(email, password) {
            const { data, error } = await db.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;
            return data;
        }

        async function logout() {
            await db.auth.signOut();
            currentUser = null;
            showLoginPage();
        }

        // Event Listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorEl = document.getElementById('loginError');
                const spinner = document.getElementById('loginSpinner');
                const btn = document.getElementById('loginBtn');

                errorEl.classList.add('hidden');
                spinner.classList.remove('hidden');
                btn.disabled = true;

                try {
                    const { user } = await login(email, password);
                    currentUser = user;
                    showAdminDashboard();
                } catch (error) {
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                } finally {
                    spinner.classList.add('hidden');
                    btn.disabled = false;
                }
            });

            // Post form
            document.getElementById('postForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await savePost();
            });

            // Title to slug
            document.getElementById('postTitle').addEventListener('input', (e) => {
                const slug = generateSlug(e.target.value);
                document.getElementById('postSlug').value = slug;
            });

            // Search and filter
            document.getElementById('searchPosts').addEventListener('input', debounce(filterPosts, 300));
            document.getElementById('filterStatus').addEventListener('change', filterPosts);

            // Image upload
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('imageInput');

            imageUploadArea.addEventListener('click', () => imageInput.click());
            imageUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageUploadArea.classList.add('border-accent');
            });
            imageUploadArea.addEventListener('dragleave', () => {
                imageUploadArea.classList.remove('border-accent');
            });
            imageUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                imageUploadArea.classList.remove('border-accent');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleImageUpload(file);
                }
            });
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            });

            // Tag input enter key
            document.getElementById('tagInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });
        }

        // Editor
        function initializeEditor() {
            if (quill) return;

            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image'],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Write your post content here...'
            });
        }

        // Categories
        async function loadCategories() {
            try {
                const { data, error } = await db
                    .from('blog_categories')
                    .select('*')
                    .order('name');

                if (error) throw error;

                categories = data || [];
                const select = document.getElementById('postCategory');
                select.innerHTML = '<option value="">Select a category</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Posts
        let allPosts = [];

        async function loadPosts() {
            const loadingEl = document.getElementById('loadingPosts');
            const tableBody = document.getElementById('postsTableBody');
            const noPostsEl = document.getElementById('noPostsMessage');

            loadingEl.classList.remove('hidden');
            tableBody.innerHTML = '';
            noPostsEl.classList.add('hidden');

            try {
                const { data, error } = await db
                    .from('blog_posts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allPosts = data || [];
                updateStats();
                renderPosts(allPosts);
            } catch (error) {
                showToast('Error loading posts: ' + error.message, 'error');
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        function updateStats() {
            const total = allPosts.length;
            const published = allPosts.filter(p => p.published).length;
            const drafts = total - published;

            document.getElementById('totalPosts').textContent = total;
            document.getElementById('publishedPosts').textContent = published;
            document.getElementById('draftPosts').textContent = drafts;
        }

        function renderPosts(posts) {
            const tableBody = document.getElementById('postsTableBody');
            const noPostsEl = document.getElementById('noPostsMessage');

            if (posts.length === 0) {
                tableBody.innerHTML = '';
                noPostsEl.classList.remove('hidden');
                return;
            }

            noPostsEl.classList.add('hidden');
            tableBody.innerHTML = posts.map(post => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            ${post.featured_image ?
                                `<img src="${post.featured_image}" class="w-12 h-12 rounded-lg object-cover">` :
                                `<div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="image" class="w-6 h-6 text-gray-400"></i>
                                </div>`
                            }
                            <div>
                                <p class="font-medium text-gray-900">${escapeHtml(post.title)}</p>
                                <p class="text-sm text-gray-500 truncate max-w-xs">${escapeHtml(post.excerpt || '')}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 hidden md:table-cell">
                        <span class="text-sm text-gray-600">${post.category || '-'}</span>
                    </td>
                    <td class="px-6 py-4">
                        ${post.published ?
                            `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                                Published
                            </span>` :
                            `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <span class="w-1.5 h-1.5 bg-yellow-500 rounded-full"></span>
                                Draft
                            </span>`
                        }
                        ${post.featured ?
                            `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 ml-1">
                                Featured
                            </span>` : ''
                        }
                    </td>
                    <td class="px-6 py-4 hidden sm:table-cell">
                        <span class="text-sm text-gray-500">${formatDate(post.created_at)}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="editPost('${post.id}')" class="p-2 text-gray-500 hover:text-accent hover:bg-accent/10 rounded-lg transition">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="showDeleteModal('${post.id}', '${escapeHtml(post.title).replace(/'/g, "\\'")}')" class="p-2 text-gray-500 hover:text-red-500 hover:bg-red-50 rounded-lg transition">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        function filterPosts() {
            const search = document.getElementById('searchPosts').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            let filtered = allPosts;

            if (search) {
                filtered = filtered.filter(post =>
                    post.title.toLowerCase().includes(search) ||
                    (post.excerpt && post.excerpt.toLowerCase().includes(search))
                );
            }

            if (status === 'published') {
                filtered = filtered.filter(post => post.published);
            } else if (status === 'draft') {
                filtered = filtered.filter(post => !post.published);
            }

            renderPosts(filtered);
        }

        // Editor View
        function showEditor(post = null) {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('editorView').classList.remove('hidden');

            // Reset form
            document.getElementById('postForm').reset();
            document.getElementById('postId').value = '';
            quill.setContents([]);
            tags = [];
            renderTags();
            selectColor('teal');
            removeImage();
            document.getElementById('postAuthor').value = 'Turrant Team';

            if (post) {
                // Populate form with post data
                document.getElementById('postId').value = post.id;
                document.getElementById('postTitle').value = post.title;
                document.getElementById('postSlug').value = post.slug;
                document.getElementById('postExcerpt').value = post.excerpt || '';
                quill.root.innerHTML = post.content || '';
                document.getElementById('metaTitle').value = post.meta_title || '';
                document.getElementById('metaDescription').value = post.meta_description || '';
                document.getElementById('postPublished').checked = post.published;
                document.getElementById('postFeatured').checked = post.featured;
                document.getElementById('postCategory').value = post.category || '';
                document.getElementById('postAuthor').value = post.author || 'Turrant Team';

                if (post.featured_image) {
                    document.getElementById('featuredImage').value = post.featured_image;
                    document.getElementById('previewImg').src = post.featured_image;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                }

                if (post.tags) {
                    tags = Array.isArray(post.tags) ? post.tags : [];
                    renderTags();
                }

                selectColor(post.card_color || 'teal');
            }

            lucide.createIcons();
        }

        function showDashboard() {
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('editorView').classList.add('hidden');
            loadPosts();
        }

        async function editPost(id) {
            const post = allPosts.find(p => p.id === id);
            if (post) {
                showEditor(post);
            }
        }

        async function savePost() {
            const saveBtn = document.getElementById('saveBtn');
            const saveBtnText = document.getElementById('saveBtnText');
            const saveSpinner = document.getElementById('saveSpinner');

            saveBtn.disabled = true;
            saveBtnText.textContent = 'Saving...';
            saveSpinner.classList.remove('hidden');

            try {
                const postId = document.getElementById('postId').value;
                const isPublished = document.getElementById('postPublished').checked;

                const postData = {
                    title: document.getElementById('postTitle').value,
                    slug: document.getElementById('postSlug').value || generateSlug(document.getElementById('postTitle').value),
                    excerpt: document.getElementById('postExcerpt').value,
                    content: quill.root.innerHTML,
                    featured_image: document.getElementById('featuredImage').value || null,
                    card_color: document.getElementById('cardColor').value,
                    author: document.getElementById('postAuthor').value || 'Turrant Team',
                    category: document.getElementById('postCategory').value || null,
                    tags: tags,
                    meta_title: document.getElementById('metaTitle').value || null,
                    meta_description: document.getElementById('metaDescription').value || null,
                    published: isPublished,
                    featured: document.getElementById('postFeatured').checked,
                    updated_at: new Date().toISOString()
                };

                // Set published_at if publishing for the first time
                if (isPublished && !postId) {
                    postData.published_at = new Date().toISOString();
                }

                let result;
                if (postId) {
                    // Update existing post
                    result = await db
                        .from('blog_posts')
                        .update(postData)
                        .eq('id', postId)
                        .select();
                } else {
                    // Create new post
                    postData.created_at = new Date().toISOString();
                    if (isPublished) {
                        postData.published_at = new Date().toISOString();
                    }
                    result = await db
                        .from('blog_posts')
                        .insert(postData)
                        .select();
                }

                if (result.error) throw result.error;

                showToast(postId ? 'Post updated successfully!' : 'Post created successfully!', 'success');
                showDashboard();
            } catch (error) {
                showToast('Error saving post: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtnText.textContent = 'Save Post';
                saveSpinner.classList.add('hidden');
            }
        }

        // Delete
        function showDeleteModal(id, title) {
            deletePostId = id;
            document.getElementById('deletePostTitle').textContent = title;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            deletePostId = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        async function confirmDelete() {
            if (!deletePostId) return;

            const btn = document.getElementById('confirmDeleteBtn');
            const spinner = document.getElementById('deleteSpinner');

            btn.disabled = true;
            spinner.classList.remove('hidden');

            try {
                const { error } = await db
                    .from('blog_posts')
                    .delete()
                    .eq('id', deletePostId);

                if (error) throw error;

                showToast('Post deleted successfully!', 'success');
                closeDeleteModal();
                loadPosts();
            } catch (error) {
                showToast('Error deleting post: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        // Image Upload
        async function handleImageUpload(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showToast('Image must be less than 5MB', 'error');
                return;
            }

            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');

            uploadPlaceholder.classList.add('hidden');
            uploadProgress.classList.remove('hidden');

            try {
                // Compress image
                const compressedFile = await compressImage(file);

                progressBar.style.width = '50%';

                // Upload to Supabase Storage
                const fileName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                const { data, error } = await db.storage
                    .from('blog-images')
                    .upload(fileName, compressedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                progressBar.style.width = '100%';

                // Get public URL
                const { data: urlData } = db.storage
                    .from('blog-images')
                    .getPublicUrl(fileName);

                document.getElementById('featuredImage').value = urlData.publicUrl;
                document.getElementById('previewImg').src = urlData.publicUrl;
                document.getElementById('imagePreview').classList.remove('hidden');

                showToast('Image uploaded successfully!', 'success');
            } catch (error) {
                showToast('Error uploading image: ' + error.message, 'error');
                uploadPlaceholder.classList.remove('hidden');
            } finally {
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
            }
        }

        async function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 1200;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(
                        (blob) => {
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        },
                        'image/jpeg',
                        0.8
                    );
                };

                img.src = URL.createObjectURL(file);
            });
        }

        function removeImage() {
            document.getElementById('featuredImage').value = '';
            document.getElementById('previewImg').src = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('imageInput').value = '';
        }

        // Tags
        function addTag() {
            const input = document.getElementById('tagInput');
            const tag = input.value.trim();

            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                renderTags();
            }

            input.value = '';
        }

        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = tags.map(tag => `
                <span class="tag-chip">
                    ${escapeHtml(tag)}
                    <button type="button" onclick="removeTag('${escapeHtml(tag).replace(/'/g, "\\'")}')"></button>
                </span>
            `).join('');
            document.getElementById('postTags').value = JSON.stringify(tags);
        }

        // Card Color
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.remove('ring-gray-900');
                btn.classList.add('ring-transparent');
            });

            const selectedBtn = document.querySelector(`[data-color="${color}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('ring-transparent');
                selectedBtn.classList.add('ring-gray-900');
            }

            document.getElementById('cardColor').value = color;
        }

        // Utilities
        function generateSlug(text) {
            return text
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
